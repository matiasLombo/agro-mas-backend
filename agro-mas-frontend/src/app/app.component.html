<mat-sidenav-container class="sidenav-container">

  <mat-sidenav #sidenav mode="over" position="start" class="sidenav-menu">
    <div class="sidenav-header">
      <div class="sidenav-logo">
        <mat-icon class="logo-icon">agriculture</mat-icon>
        <h2 class="logo-title">Agro Mas</h2>
      </div>
      <button mat-icon-button class="close-button" (click)="sidenav.close()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="sidenav-content">
      <ng-container *ngIf="!(isAuthenticated$ | async)">
        <div class="menu-section">
          <h3 class="section-title">Navegación</h3>
          <nav class="menu-nav">
            <a mat-button class="menu-item" routerLink="/marketplace" (click)="sidenav.close()"
              routerLinkActive="active">
              <mat-icon class="menu-icon">home</mat-icon>
              <span class="menu-text">Inicio</span>
            </a>
          </nav>
        </div>

        <mat-divider class="section-divider"></mat-divider>

        <div class="menu-section">
          <h3 class="section-title">Cuenta</h3>
          <nav class="menu-nav">
            <a mat-button class="menu-item" routerLink="/login" (click)="sidenav.close()">
              <mat-icon class="menu-icon">login</mat-icon>
              <span class="menu-text">Iniciar Sesión</span>
            </a>
            <a mat-button class="menu-item register-item" routerLink="/register" (click)="sidenav.close()">
              <mat-icon class="menu-icon">person_add</mat-icon>
              <span class="menu-text">Registrarse</span>
            </a>
          </nav>
        </div>
      </ng-container>

      <ng-container *ngIf="isAuthenticated$ | async">
        <div class="user-profile">
          <div class="user-avatar">
            <mat-icon class="avatar-icon">person</mat-icon>
          </div>
          <div class="user-info">
            <span class="user-name">¡Hola, {{ (currentUser$ | async)?.first_name || 'Usuario' }}!</span>
            <span class="user-status">En línea</span>
          </div>
        </div>

        <mat-divider class="section-divider"></mat-divider>

        <div class="menu-section">
          <h3 class="section-title">Menu Principal</h3>
          <nav class="menu-nav">
            <a mat-button class="menu-item" routerLink="/marketplace" (click)="sidenav.close()"
              routerLinkActive="active">
              <mat-icon class="menu-icon">home</mat-icon>
              <span class="menu-text">Marketplace</span>
            </a>
            <a mat-button class="menu-item" routerLink="/dashboard" (click)="sidenav.close()" routerLinkActive="active">
              <mat-icon class="menu-icon">dashboard</mat-icon>
              <span class="menu-text">Dashboard</span>
            </a>
          </nav>
        </div>

        <mat-divider class="section-divider"></mat-divider>

        <div class="menu-section">
          <h3 class="section-title">Mis Actividades</h3>
          <nav class="menu-nav">
            <a mat-button class="menu-item" routerLink="/my-purchases" (click)="sidenav.close()"
              routerLinkActive="active">
              <mat-icon class="menu-icon">shopping_cart</mat-icon>
              <span class="menu-text">Mis compras</span>
            </a>
            <a mat-button class="menu-item" routerLink="/my-publications" (click)="sidenav.close()"
              routerLinkActive="active">
              <mat-icon class="menu-icon">sell</mat-icon>
              <span class="menu-text">Mis publicaciones</span>
            </a>
          </nav>
        </div>

        <mat-divider class="section-divider"></mat-divider>

        <div class="menu-section logout-section">
          <button mat-button class="menu-item logout-item" (click)="logout(); sidenav.close()">
            <mat-icon class="menu-icon">logout</mat-icon>
            <span class="menu-text">Cerrar Sesión</span>
          </button>
        </div>
      </ng-container>
    </div>

    <div class="sidenav-footer">
      <div class="footer-brand">
        <span class="brand-text">© 2025 Agro Mas</span>
        <span class="version-text">v1.0</span>
      </div>
    </div>
  </mat-sidenav>

  <mat-sidenav-content>
    <div class="app-container">
      <header class="header">
        <div class="header-content">
          <nav class="navigation">
            <div class="nav-left">
              <button (click)="sidenav.open()" class="menu-toggle-button">
                <mat-icon>menu</mat-icon>
              </button>
              <div class="logo-section">
                <a routerLink="/marketplace" class="logo-link">
                  <mat-icon class="logo-icon">agriculture</mat-icon>
                  <h1 class="logo-text">{{ title }}</h1>
                </a>
              </div>
            </div>

            <div class="nav-right">
              <ng-container *ngIf="!(isAuthenticated$ | async)">
                <button mat-button routerLink="/login" routerLinkActive="active" class="nav-link">Iniciar Sesión</button>
                <button mat-flat-button routerLink="/register" routerLinkActive="active" class="nav-button">Registrarse</button>
              </ng-container>

              <ng-container *ngIf="isAuthenticated$ | async">
                <div class="user-section">
                  <div class="user-avatar">
                    <mat-icon class="avatar-icon">person</mat-icon>
                  </div>
                  <div class="user-menu-container">
                    <button 
                      class="user-menu-trigger"
                      (click)="toggleUserMenu()"
                      [class.active]="showUserMenu">
                      <span class="user-greeting">
                        ¡Hola, {{ (currentUser$ | async)?.first_name || 'Usuario' }}!
                      </span>
                      <mat-icon class="dropdown-icon" [class.rotated]="showUserMenu">arrow_drop_down</mat-icon>
                    </button>

                    <!-- Custom dropdown menu -->
                    <div class="custom-dropdown-menu" [class.show]="showUserMenu" (click)="$event.stopPropagation()">
                      <!-- User info header -->
                      <div class="menu-header">
                        <div class="user-info">
                          <div class="user-avatar-large">
                            <mat-icon>person</mat-icon>
                          </div>
                          <div class="user-details">
                            <div class="user-name">{{ (currentUser$ | async)?.first_name }} {{ (currentUser$ | async)?.last_name }}</div>
                            <div class="user-email">{{ (currentUser$ | async)?.email }}</div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Menu items -->
                      <div class="menu-items">
                        <button class="menu-item" (click)="openEditProfile(); closeUserMenu()">
                          <mat-icon>edit</mat-icon>
                          <span>Editar Perfil</span>
                        </button>
                        
                        <button class="menu-item" *ngIf="(currentUser$ | async)?.role === 'seller'" (click)="openSellerSettings(); closeUserMenu()">
                          <mat-icon>store</mat-icon>
                          <span>Perfil de Vendedor</span>
                        </button>
                        
                        <button class="menu-item" (click)="viewMyActivity(); closeUserMenu()">
                          <mat-icon>history</mat-icon>
                          <span>Mi Actividad</span>
                        </button>
                        
                        <div class="menu-divider"></div>
                        
                        <button class="menu-item logout-item" (click)="logout(); closeUserMenu()">
                          <mat-icon>logout</mat-icon>
                          <span>Cerrar Sesión</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </nav>
        </div>
      </header>

      <main class="main-content">
        <router-outlet></router-outlet>
      </main>

      <footer class="footer">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo">
              <span class="footer-icon">🌾</span>
              <span class="footer-brand">Agro Mas</span>
            </div>
            <p class="footer-description">
              Tu marketplace de confianza para productos agropecuarios. Conectamos productores locales con compradores.
            </p>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 Agro Mas. Todos los derechos reservados.</p>
          <p>Desarrollado con dedicación para el sector agropecuario</p>
        </div>
      </footer>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>